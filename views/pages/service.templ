package pages

import (
	"fmt"

	"github.com/fr0stylo/ddash/views/base"
	"github.com/fr0stylo/ddash/views/components"
)

templ ServicePage(service components.ServiceDetail, showMetadataBadges bool, showDeploymentHistory bool, allowServiceMetadataEditing bool, showIntegrationTypeBadges bool, csrfToken string) {
		@base.Doc(service.Title) {
			@base.AppHeader(service.Title, service.Description) {
				if showMetadataBadges && service.MissingMetadata > 0 {
					<span class={ "inline-flex h-9 items-center rounded-lg border px-3 text-xs font-semibold " + metadataHeaderBadgeClass(service.MissingMetadata) }>{ service.MissingMetadata } metadata missing</span>
				}
			}
			<main class="mx-auto max-w-7xl px-4 py-8 sm:px-6 lg:px-8">
				<div
					class="flex flex-col gap-8"
						x-data={ fmt.Sprintf(`{
							metadataFields: %s,
							csrfToken: %q,
							savingMetadata: false,
						metadataToast: '',
						setToast(message) {
							this.metadataToast = message;
							setTimeout(() => { this.metadataToast = ''; }, 2200);
						},
						async saveMetadata() {
							this.savingMetadata = true;
							try {
							const response = await fetch(%q, {
								method: 'POST',
								headers: { 'Content-Type': 'application/json', 'X-CSRF-Token': this.csrfToken },
								body: JSON.stringify({ fields: this.metadataFields }),
							});
								if (!response.ok) {
									throw new Error('save failed');
								}
								this.setToast('Metadata saved');
							} catch (error) {
								this.setToast('Metadata save failed');
							} finally {
								this.savingMetadata = false;
							}
						}
					}`, components.ServiceFieldsJSON(service.MetadataFields), csrfToken, service.MetadataSaveURL) }
				>
					<div
						class="fixed right-6 top-6 rounded-lg border border-gray-200 bg-white px-4 py-2 text-sm text-gray-700 shadow-lg"
						x-show="metadataToast"
						x-transition
						x-text="metadataToast"
					></div>
					<section class="grid gap-6 lg:grid-cols-3">
						<div class="space-y-6 lg:col-span-2">
						@components.Card("Environments") {
							<div class="mb-3 grid gap-2 sm:grid-cols-3">
								for _, env := range service.Environments {
									<div class="rounded-lg border border-gray-200 bg-gray-50 px-3 py-2 text-xs text-gray-600">
										<div class="font-semibold text-gray-800">{ env.Name }</div>
										<div class="mt-1">{ fmt.Sprint(env.DeployCount7d) } deploys / 7d</div>
										<div>{ fmt.Sprint(env.DeployCount30d) } deploys / 30d 路 { env.DailyRate30d }</div>
									</div>
								}
							</div>
							<div class="overflow-hidden rounded-lg border border-gray-200">
								<table class="min-w-full divide-y divide-gray-200 text-sm">
									<thead class="bg-gray-50 text-xs uppercase tracking-wide text-gray-500">
										<tr>
											<th class="px-4 py-3 text-left font-medium">Environment</th>
											<th class="px-4 py-3 text-left font-medium">Last deploy</th>
											<th class="px-4 py-3 text-left font-medium">Age</th>
											<th class="px-4 py-3 text-left font-medium">Deployed ref</th>
										</tr>
									</thead>
									<tbody class="divide-y divide-gray-100">
										if len(service.Environments) == 0 {
											<tr>
												<td class="px-4 py-6 text-center text-sm text-gray-500" colspan="4">No environments yet.</td>
											</tr>
										}
										for _, env := range service.Environments {
											<tr class="hover:bg-gray-50">
												<td class="px-4 py-3 font-medium text-gray-900">{ env.Name }</td>
												<td class="px-4 py-3 text-gray-600">{ env.LastDeploy }</td>
												<td class="px-4 py-3 text-gray-500">{ env.LastDeployedAgo }</td>
											<td class="px-4 py-3 font-mono text-xs text-gray-700">
													if env.CommitURL != "" {
														<a class="text-gray-700 hover:text-gray-900 underline-offset-4 hover:underline" href={ env.CommitURL } target="_blank" rel="noreferrer">{ env.DeployedRef }</a>
													} else {
														<span>{ env.DeployedRef }</span>
													}
											</td>
											</tr>
										}
									</tbody>
								</table>
							</div>
						}

						{{ total := len(service.PendingCommits) }}
						if service.IntegrationType == "github" && total > 0 {
							@components.Card("Changes not in production") {
								<div class="space-y-3">
									{{ limit := 20 }}
									{{ shown := total }}
									if total > limit {
										{{ shown = limit }}
									}
									<div class="text-xs text-gray-400">Showing { fmt.Sprint(shown) } of { fmt.Sprint(total) } changes</div>
									for i, commit := range service.PendingCommits {
										if i >= limit {
											break
										}
										<div class="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
											<div class="text-sm text-gray-700">{ commit.Message }</div>
											<a class="font-mono text-xs text-gray-600 hover:text-gray-900" href={ commit.URL } target="_blank" rel="noreferrer">[{ commit.SHA }]</a>
										</div>
									}
									if total > limit {
										<details class="group rounded-lg border border-gray-200 bg-white px-4 py-3">
											<summary class="flex cursor-pointer list-none items-center justify-between text-xs font-medium text-gray-500">
												<span>Show all remaining { fmt.Sprint(total - limit) } changes</span>
												<span class="text-xs text-gray-400 group-open:hidden">Expand</span>
												<span class="text-xs text-gray-400 hidden group-open:inline">Collapse</span>
											</summary>
											<div class="mt-3 space-y-3">
												for i, commit := range service.PendingCommits {
													if i < limit {
														continue
													}
													<div class="flex flex-col gap-1 rounded-lg border border-gray-200 bg-white px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
														<div class="text-sm text-gray-700">{ commit.Message }</div>
														<a class="font-mono text-xs text-gray-600 hover:text-gray-900" href={ commit.URL } target="_blank" rel="noreferrer">[{ commit.SHA }]</a>
													</div>
												}
											</div>
											</details>
									}
								</div>
							}
						}

						if showDeploymentHistory {
						@components.Card("Deployment history") {
							<div class="space-y-3">
								if len(service.DeploymentHistory) == 0 {
									<div class="rounded-lg border border-dashed border-gray-200 bg-gray-50 px-4 py-3 text-sm text-gray-500">
										No deployment history yet.
									</div>
								}
								for _, record := range service.DeploymentHistory {
									<div class="flex flex-col gap-2 rounded-lg border border-gray-200 bg-white px-4 py-3 sm:flex-row sm:items-center sm:justify-between">
										<div class="text-sm text-gray-700">
											<span class="font-medium">{ record.DeployedAt }</span>
											if record.DeployedAgo != "" {
												<span class="text-gray-400">路</span>
												<span>{ record.DeployedAgo }</span>
											}
											<span class="text-gray-400">路</span>
											{ fmt.Sprint(record.Commits) } commits
											if record.Environment != "" {
												<span class="text-gray-400">路</span>
												<span class="rounded-full border border-gray-200 bg-white px-2 py-0.5 text-xs text-gray-600">{ record.Environment }</span>
											}
										</div>
										if record.ReleaseURL != "" {
											<a class="font-mono text-xs text-gray-600 hover:text-gray-900" href={ record.ReleaseURL } target="_blank" rel="noreferrer">{ record.Ref }</a>
										} else {
											<span class="font-mono text-xs text-gray-600">{ record.Ref }</span>
										}
										<div class="text-xs text-gray-500">{ record.ChangeLog }</div>
										if record.PreviousRef != "" {
											<div class="text-[11px] font-mono text-gray-400">from { record.PreviousRef }</div>
										}
									</div>
								}
							</div>
						}
						}
					</div>

					<div class="space-y-6">
						@components.Card("Service metadata") {
							<div class="space-y-4">
								if len(service.MetadataFields) == 0 {
									<div class="rounded-lg border border-dashed border-gray-200 bg-gray-50 px-3 py-2 text-sm text-gray-500">
										No metadata requirements configured yet. Add metadata requirements in <a class="font-medium text-gray-700 underline-offset-2 hover:underline" href="/settings#metadata-requirements">Settings</a>.
									</div>
								}
								<template x-for="(field, index) in metadataFields" :key="field.label + '-' + index">
									<div class="space-y-1">
										<label class="text-xs font-medium text-gray-500" x-text="field.label"></label>
										<input
											type="text"
											x-model="field.value"
											class="h-10 w-full rounded-lg border border-gray-200 bg-white px-3 text-sm shadow-sm outline-none focus:border-gray-300 focus:ring-2 focus:ring-gray-200"
											placeholder="Missing"
											if !allowServiceMetadataEditing { readonly }
										/>
									</div>
								</template>
								<div class="flex justify-end" x-show="metadataFields.length > 0 && allowServiceMetadataEditing">
									<button type="button" class="inline-flex h-10 items-center rounded-lg bg-gray-900 px-4 text-sm font-medium text-white shadow-sm hover:bg-gray-800" @click="saveMetadata()" :disabled="savingMetadata">
										<span x-show="!savingMetadata">Save metadata</span>
										<span x-show="savingMetadata">Saving...</span>
									</button>
								</div>
							</div>
						}
						if showIntegrationTypeBadges {
							<div class="rounded-lg border border-sky-200 bg-sky-50 px-3 py-2 text-xs font-medium text-sky-700">Integration: { service.IntegrationType }</div>
						}
					</div>
				</section>
			</div>
		</main>
	}
}

func metadataHeaderBadgeClass(missing int) string {
	if missing >= 3 {
		return "border-red-200 bg-red-50 text-red-700"
	}
	return "border-amber-200 bg-amber-50 text-amber-700"
}
