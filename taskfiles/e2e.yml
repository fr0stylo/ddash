version: '3'

tasks:
  e2e:
    desc: Run local end-to-end Playwright checklist suite
    cmds:
      - |
        set -euo pipefail

        if ss -ltn '( sport = :{{.PORT}} )' | grep -q LISTEN; then
          echo "Port {{.PORT}} is already in use. Stop the existing process or run: task e2e PORT=<free-port>." >&2
          exit 1
        fi

        mkdir -p tmp
        db_path="tmp/e2e-{{.PORT}}"
        server_bin="tmp/ddash-e2e"
        server_log="/tmp/ddash-e2e-{{.PORT}}.log"
        pid_file="/tmp/ddash-e2e-{{.PORT}}.pid"
        base_url="http://localhost:{{.PORT}}"

        cleanup() {
          if [ -f "$pid_file" ]; then
            kill "$(cat "$pid_file")" 2>/dev/null || true
            rm -f "$pid_file"
          fi
          pkill -f "$server_bin" 2>/dev/null || true
        }
        trap cleanup EXIT

        go build -o "$server_bin" ./apps/ddash
        DDASH_ENV=dev DDASH_SESSION_SECRET=e2e-session-secret DDASH_PORT={{.PORT}} DDASH_DB_PATH="$db_path" "$server_bin" > "$server_log" 2>&1 &
        echo "$!" > "$pid_file"

        for i in $(seq 1 40); do
          if curl -fsS "$base_url/login" >/dev/null 2>&1; then
            break
          fi
          if [ "$i" -eq 40 ]; then
            echo "Server did not start in time. Check $server_log" >&2
            exit 1
          fi
          sleep 1
        done

        sqlite3 "${db_path}.sqlite" "
        INSERT OR IGNORE INTO organizations (id,name,auth_token,join_code,webhook_secret,enabled)
        VALUES (2001,'e2e-org','e2eauthtoken01','e2ejoincode01','e2esecret01',1);
        UPDATE organizations SET
          name='e2e-org',
          auth_token='e2eauthtoken01',
          join_code='e2ejoincode01',
          webhook_secret='e2esecret01',
          enabled=1
        WHERE id=2001;

        INSERT OR IGNORE INTO users (id,github_id,email,nickname,name,avatar_url)
        VALUES (3001,'e2e-admin','e2e-admin@example.local','e2e-admin','E2E Admin','');
        UPDATE users SET github_id='e2e-admin', nickname='e2e-admin', name='E2E Admin'
        WHERE email='e2e-admin@example.local';

        INSERT OR IGNORE INTO organization_members (organization_id,user_id,role)
        SELECT 2001,id,'owner' FROM users WHERE email='e2e-admin@example.local';
        UPDATE organization_members SET role='owner'
        WHERE organization_id=2001 AND user_id=(SELECT id FROM users WHERE email='e2e-admin@example.local');

        DELETE FROM organization_join_requests
        WHERE user_id IN (SELECT id FROM users WHERE email LIKE 'e2e-joiner-%@example.local' OR email LIKE 'e2e-reject-%@example.local');
        DELETE FROM organization_members
        WHERE user_id IN (SELECT id FROM users WHERE email LIKE 'e2e-joiner-%@example.local' OR email LIKE 'e2e-reject-%@example.local');

        INSERT OR IGNORE INTO organization_features (organization_id, feature_key, is_enabled) VALUES
          (2001, 'show_service_detail_insights', 1),
          (2001, 'show_service_dependencies', 1),
          (2001, 'show_deployment_history', 1),
          (2001, 'show_service_delivery_metrics', 1);
        "

        go run ./apps/eventpublisher -endpoint "$base_url" -token e2eauthtoken01 -secret e2esecret01 -type service.deployed -service orders -environment staging -artifact pkg:generic/orders@a1
        go run ./apps/eventpublisher -endpoint "$base_url" -token e2eauthtoken01 -secret e2esecret01 -type service.upgraded -service orders -environment staging -artifact pkg:generic/orders@a2
        go run ./apps/eventpublisher -endpoint "$base_url" -token e2eauthtoken01 -secret e2esecret01 -type service.deployed -service orders -environment production -artifact pkg:generic/orders@p1
        go run ./apps/eventpublisher -endpoint "$base_url" -token e2eauthtoken01 -secret e2esecret01 -type service.deployed -service billing -environment staging -artifact pkg:generic/billing@b1

        npm ci
        npx playwright install chromium

        status=0
        E2E_BASE_URL="$base_url" npx playwright test tests/e2e/smoke.spec.js --reporter=list || status=$?
        cleanup
        trap - EXIT
        exit "$status"
    vars:
      PORT: 18080
