version: '3'

tasks:
  load:server:
    desc: Start isolated DDash server for load tests
    cmds:
      - |
        set -euo pipefail
        if ss -ltn '( sport = :{{.PORT}} )' | grep -q LISTEN; then
          echo "Port {{.PORT}} is already in use. Stop existing process or set PORT=<free-port>." >&2
          exit 1
        fi
        mkdir -p tmp
        go build -o tmp/ddash-load ./apps/ddash
        DDASH_ENV=dev DDASH_SESSION_SECRET=loadtest-session-secret DDASH_PORT={{.PORT}} DDASH_DB_PATH=tmp/loadtest tmp/ddash-load > /tmp/ddash-load.log 2>&1 & echo $! > /tmp/ddash-load.pid
        for i in $(seq 1 40); do
          if curl -fsS http://localhost:{{.PORT}}/login >/dev/null 2>&1; then
            echo "Load-test server ready on :{{.PORT}}"
            exit 0
          fi
          sleep 1
        done
        echo "Server did not start in time. Check /tmp/ddash-load.log" >&2
        exit 1
    vars:
      PORT: 19090

  load:stop:
    desc: Stop isolated DDash load-test server
    cmds:
      - |
        if [ -f /tmp/ddash-load.pid ]; then
          kill "$(cat /tmp/ddash-load.pid)" 2>/dev/null || true
          rm -f /tmp/ddash-load.pid
        fi
        pkill -f "tmp/ddash-load" 2>/dev/null || true

  load:seed:
    desc: Seed org/user baseline for load tests
    cmds:
      - |
        sqlite3 "tmp/loadtest.sqlite" "
        INSERT OR IGNORE INTO organizations (id,name,auth_token,join_code,webhook_secret,enabled)
        VALUES (9001,'loadtest-org','loadtest-token-01','loadtest-join-01','loadtest-secret-01',1);
        UPDATE organizations SET
          name='loadtest-org',
          auth_token='loadtest-token-01',
          join_code='loadtest-join-01',
          webhook_secret='loadtest-secret-01',
          enabled=1
        WHERE id=9001;

        INSERT OR IGNORE INTO users (id,github_id,email,nickname,name,avatar_url)
        VALUES (9001,'loadtest-admin','loadtest-admin@example.local','loadtest-admin','Load Test Admin','');
        UPDATE users SET github_id='loadtest-admin', nickname='loadtest-admin', name='Load Test Admin'
        WHERE email='loadtest-admin@example.local';

        INSERT OR IGNORE INTO organization_members (organization_id,user_id,role)
        SELECT 9001,id,'owner' FROM users WHERE email='loadtest-admin@example.local';
        UPDATE organization_members SET role='owner'
        WHERE organization_id=9001 AND user_id=(SELECT id FROM users WHERE email='loadtest-admin@example.local');
        "
      - go run ./apps/eventpublisher -endpoint=http://localhost:{{.PORT}} -token=loadtest-token-01 -secret=loadtest-secret-01 -type=service.deployed -service=orders -environment=staging -artifact=pkg:generic/orders@seed1
      - go run ./apps/eventpublisher -endpoint=http://localhost:{{.PORT}} -token=loadtest-token-01 -secret=loadtest-secret-01 -type=service.deployed -service=orders -environment=production -artifact=pkg:generic/orders@seed2
      - go run ./apps/eventpublisher -endpoint=http://localhost:{{.PORT}} -token=loadtest-token-01 -secret=loadtest-secret-01 -type=service.deployed -service=billing -environment=staging -artifact=pkg:generic/billing@seed1
    vars:
      PORT: 19090

  load:test:ingest:
    desc: Run k6 ingest load scenario
    cmds:
      - BASE_URL=http://localhost:{{.PORT}} AUTH_TOKEN=loadtest-token-01 WEBHOOK_SECRET=loadtest-secret-01 INGEST_INCLUDE_CUSTOM_TYPES={{.INCLUDE_CUSTOM_TYPES}} k6 run loadtest/ingest.js
    vars:
      PORT: 19090
      INCLUDE_CUSTOM_TYPES: false

  load:test:read:
    desc: Run k6 read load scenario
    cmds:
      - BASE_URL=http://localhost:{{.PORT}} k6 run loadtest/read.js
    vars:
      PORT: 19090

  load:test:mixed:
    desc: Run k6 mixed read and ingest scenario
    cmds:
      - BASE_URL=http://localhost:{{.PORT}} AUTH_TOKEN=loadtest-token-01 WEBHOOK_SECRET=loadtest-secret-01 k6 run loadtest/mixed.js
    vars:
      PORT: 19090

  load:report:
    desc: Show quick pointers to load-test logs
    cmds:
      - ls /tmp/ddash-load.log
      - sqlite3 "tmp/loadtest.sqlite" "SELECT COUNT(*) AS event_store_rows FROM event_store;"

  load:all:
    desc: Run full local load-test flow (server, seed, ingest, read, mixed, report, stop)
    cmds:
      - |
        set -euo pipefail
        cleanup() {
          task load:stop >/dev/null 2>&1 || true
        }
        trap cleanup EXIT

        task load:server PORT={{.PORT}}
        task load:seed PORT={{.PORT}}
        task load:test:ingest PORT={{.PORT}}
        task load:test:read PORT={{.PORT}}
        task load:test:mixed PORT={{.PORT}}
        task load:report
        cleanup
        trap - EXIT
    vars:
      PORT: 19090
